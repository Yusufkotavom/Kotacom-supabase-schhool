---
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="Checkout - Kotacom">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Checkout</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Checkout Form -->
      <div class="lg:col-span-2">
        <form id="checkout-form" class="space-y-6">
          <!-- Customer Information -->
          <div class="bg-white p-6 rounded-lg border">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Customer Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                <input type="text" id="firstName" name="firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                <input type="email" id="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                <input type="tel" id="phone" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
            </div>
          </div>
          
          <!-- Shipping Address -->
          <div class="bg-white p-6 rounded-lg border">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Shipping Address</h2>
            <div class="space-y-4">
              <div>
                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                <input type="text" id="address" name="address" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                  <input type="text" id="city" name="city" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                  <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State/Province *</label>
                  <input type="text" id="state" name="state" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                  <label for="zipCode" class="block text-sm font-medium text-gray-700 mb-1">ZIP/Postal Code *</label>
                  <input type="text" id="zipCode" name="zipCode" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
              </div>
              <div>
                <label for="country" class="block text-sm font-medium text-gray-700 mb-1">Country *</label>
                <select id="country" name="country" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">Select Country</option>
                  <option value="ID">Indonesia</option>
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                  <option value="GB">United Kingdom</option>
                  <option value="AU">Australia</option>
                  <option value="DE">Germany</option>
                  <option value="FR">France</option>
                  <option value="JP">Japan</option>
                  <option value="SG">Singapore</option>
                  <option value="MY">Malaysia</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Bank Transfer Information -->
          <div class="bg-white p-6 rounded-lg border">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Payment Method - Bank Transfer</h2>
            <div class="bg-blue-50 p-4 rounded-md mb-4">
              <p class="text-sm text-blue-800">
                <strong>Important:</strong> Please complete your bank transfer within 24 hours to confirm your order. 
                You will receive an email confirmation with payment instructions.
              </p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label for="bankName" class="block text-sm font-medium text-gray-700 mb-1">Bank Name *</label>
                <select id="bankName" name="bankName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">Select Bank</option>
                  <option value="BCA">BCA (Bank Central Asia)</option>
                  <option value="BNI">BNI (Bank Negara Indonesia)</option>
                  <option value="BRI">BRI (Bank Rakyat Indonesia)</option>
                  <option value="Mandiri">Bank Mandiri</option>
                  <option value="CIMB">CIMB Niaga</option>
                  <option value="Other">Other Bank</option>
                </select>
              </div>
              <div>
                <label for="accountNumber" class="block text-sm font-medium text-gray-700 mb-1">Account Number *</label>
                <input type="text" id="accountNumber" name="accountNumber" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your account number">
              </div>
              <div>
                <label for="accountHolder" class="block text-sm font-medium text-gray-700 mb-1">Account Holder Name *</label>
                <input type="text" id="accountHolder" name="accountHolder" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter account holder name">
              </div>
            </div>
          </div>
          
          <!-- Order Notes -->
          <div class="bg-white p-6 rounded-lg border">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Order Notes (Optional)</h2>
            <div>
              <label for="orderNotes" class="block text-sm font-medium text-gray-700 mb-1">Special Instructions</label>
              <textarea id="orderNotes" name="orderNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Any special instructions for your order..."></textarea>
            </div>
          </div>
          
          <!-- Submit Button -->
          <div class="flex justify-end">
            <button 
              type="submit" 
              id="place-order-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span class="btn-text">Place Order</span>
              <span class="btn-loading hidden">Processing...</span>
            </button>
          </div>
        </form>
      </div>
      
      <!-- Order Summary -->
      <div class="lg:col-span-1">
        <div class="bg-gray-50 rounded-lg p-6 sticky top-8">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Order Summary</h2>
          
          <div id="order-items" class="space-y-3 mb-6">
            <!-- Order items will be populated here -->
          </div>
          
          <div class="mb-4 text-center space-y-2">
            <a href="/cart" class="block text-sm text-blue-600 hover:text-blue-500 hover:underline">
              ← Back to Cart
            </a>
            <a href="/products" class="block text-sm text-blue-600 hover:text-blue-500 hover:underline">
              Continue Shopping
            </a>
          </div>
          
          <div class="border-t pt-4 space-y-3">
            <div class="flex justify-between text-sm">
              <span>Subtotal</span>
              <span id="subtotal">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span>Shipping</span>
              <span>Free</span>
            </div>
            <div class="border-t pt-3">
              <div class="flex justify-between text-base font-medium">
                <span>Total</span>
                <span id="total">$0.00</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  import { useCartStore } from '../lib/cartStore';
  
  class CheckoutPage {
    constructor() {
      this.form = document.getElementById('checkout-form');
      this.orderItems = document.getElementById('order-items');
      this.subtotal = document.getElementById('subtotal');
      this.total = document.getElementById('total');
      this.placeOrderBtn = document.getElementById('place-order-btn');
      
      this.init();
    }
    
    init() {
      this.renderOrderSummary();
      this.addFormListeners();
      
      // Listen for cart changes
      useCartStore.subscribe(() => {
        this.renderOrderSummary();
      });
    }
    
    renderOrderSummary() {
      const items = useCartStore.getState().items;
      const totalPrice = useCartStore.getState().getTotalPrice();
      
      this.orderItems.innerHTML = items.map(item => `
        <div class="flex justify-between text-sm">
          <span>${item.title} × ${item.quantity}</span>
          <span>$${(item.price * item.quantity).toFixed(2)}</span>
        </div>
      `).join('');
      
      this.subtotal.textContent = `$${totalPrice.toFixed(2)}`;
      this.total.textContent = `$${totalPrice.toFixed(2)}`;
    }
    
    addFormListeners() {
      this.form.addEventListener('submit', (e) => this.handleSubmit(e));
    }
    
    async handleSubmit(e) {
      e.preventDefault();
      
      if (!this.validateForm()) {
        return;
      }
      
      this.setLoading(true);
      
      try {
        const formData = new FormData(this.form);
        const orderData = {
          customer: {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            address: formData.get('address'),
            city: formData.get('city'),
            state: formData.get('state'),
            zipCode: formData.get('zipCode'),
            country: formData.get('country')
          },
          payment: {
            method: 'bank_transfer',
            bankName: formData.get('bankName'),
            accountNumber: formData.get('accountNumber'),
            accountHolder: formData.get('accountHolder')
          },
          orderNotes: formData.get('orderNotes'),
          items: useCartStore.getState().items,
          total: useCartStore.getState().getTotalPrice(),
          orderId: this.generateOrderId()
        };
        
        // Submit order
        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(orderData),
        });
        
        if (response.ok) {
          const result = await response.json();
          
          // Clear cart
          useCartStore.getState().clearCart();
          
          // Redirect to success page
          window.location.href = `/checkout/success?orderId=${result.orderId}`;
        } else {
          throw new Error('Failed to place order');
        }
        
      } catch (error) {
        console.error('Error placing order:', error);
        alert('There was an error placing your order. Please try again.');
        this.setLoading(false);
      }
    }
    
    validateForm() {
      const requiredFields = [
        'firstName', 'lastName', 'email', 'phone', 'address', 
        'city', 'state', 'zipCode', 'country', 'bankName', 
        'accountNumber', 'accountHolder'
      ];
      
      for (const field of requiredFields) {
        const input = document.getElementById(field) as HTMLInputElement;
        if (!input.value.trim()) {
          input.focus();
          alert(`Please fill in ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
          return false;
        }
      }
      
      // Validate email format
      const email = document.getElementById('email') as HTMLInputElement;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email.value)) {
        email.focus();
        alert('Please enter a valid email address');
        return false;
      }
      
      return true;
    }
    
    setLoading(loading: boolean) {
      this.placeOrderBtn.disabled = loading;
      const btnText = this.placeOrderBtn.querySelector('.btn-text') as HTMLElement;
      const btnLoading = this.placeOrderBtn.querySelector('.btn-loading') as HTMLElement;
      
      btnText.classList.toggle('hidden', loading);
      btnLoading.classList.toggle('hidden', !loading);
    }
    
    generateOrderId() {
      const timestamp = Date.now().toString();
      const random = Math.random().toString(36).substr(2, 5);
      return `ORD-${timestamp}-${random}`.toUpperCase();
    }
  }
  
  // Initialize checkout page
  document.addEventListener('DOMContentLoaded', () => {
    new CheckoutPage();
  });
</script>
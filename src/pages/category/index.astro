---
import Layout from '../../layouts/Layout.astro';
import { getPostsDirectFromSupabase } from '../../lib/supabase-direct';
import { toSlug } from '../../utils/slug-helpers';
import { getCollection } from "astro:content";

// Get all posts from different sources

// Get MDX posts from content collection
let mdxPosts: any[] = [];
try {
  const mdxCollection = await getCollection("postsMdx");
  mdxPosts = mdxCollection.map(post => ({
    data: post.data,
    slug: post.data.slug || post.id,
    url: `/${post.data.slug || post.id}`
  }));
} catch (error) {
  console.log('⚠️ No MDX posts found in content collection');
  mdxPosts = [];
}

const supabasePosts = await getPostsDirectFromSupabase(10000); // Load all posts to ensure all tags are captured
// Debug info removed for production

// Extract unique tags from all posts (MDX + Supabase)
const allTags = new Set<string>();

// Extract tags from MDX posts
mdxPosts.forEach((post: any) => {
  (post.data.tags || []).forEach((tag: string) => {
    if (tag && typeof tag === 'string') {
      allTags.add(tag);
    }
  });
});

// Extract tags from Supabase posts
(supabasePosts || []).forEach((post: any) => {
  // Debug info removed for production
  const tags = post.tags || [];
  if (Array.isArray(tags)) {
    tags.forEach((tag: any) => {
      const tagValue = typeof tag === 'string' ? tag : tag?.value || tag?.name;
      if (tagValue && typeof tagValue === 'string') {
        // Debug info removed for production
        allTags.add(tagValue);
      }
    });
  } else if (typeof tags === 'string') {
    // Try to parse as JSON if it's a string
    try {
      const parsedTags = JSON.parse(tags);
      if (Array.isArray(parsedTags)) {
        parsedTags.forEach((tag: string) => {
          if (tag && typeof tag === 'string') {
            // Debug info removed for production
            allTags.add(tag);
          }
        });
      }
    } catch {
      // If not JSON, treat as single tag
      // Debug info removed for production
      allTags.add(tags);
    }
  }
});

const uniqueTags = Array.from(allTags).sort();
// Debug info removed for production
---

<Layout title="Kategori - Kotacom.id">
  <main class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-8">Kategori</h1>
    
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {uniqueTags.map((tag) => (
        <a 
          href={`/category/${toSlug(tag)}/`}
          class="block p-4 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition-shadow border border-gray-200 dark:border-gray-700"
        >
          <span class="text-gray-900 dark:text-white font-medium">{tag}</span>
        </a>
      ))}
    </div>
  </main>
</Layout>

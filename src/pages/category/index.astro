---
import Layout from '../../layouts/Layout.astro';
import { getPostsDirectFromSupabase } from '../../lib/supabase-direct';

// Collect MD/MDX posts
const postFiles = await Astro.glob('../posts/*.{md,mdx}');
const mdxPosts = postFiles.map((post) => ({
  data: post.frontmatter,
  slug: post.file?.split('/').pop()?.replace(/\.(md|mdx)$/, '') || '',
  url: post.url,
}));

// Collect Supabase posts
const supabasePosts = await getPostsDirectFromSupabase(10000);

// Build category set (backend: tags act as categories; frontend: category only)
const categorySet = new Set<string>();

// From MDX tags
mdxPosts.forEach((post: any) => {
  (post.data.tags || []).forEach((tag: string) => {
    if (typeof tag === 'string' && tag) categorySet.add(tag);
  });
});

// From Supabase tags and category fields
(supabasePosts || []).forEach((post: any) => {
  const tags = post.tags || [];
  if (Array.isArray(tags)) {
    tags.forEach((t: any) => {
      const v = typeof t === 'string' ? t : t?.value || t?.name;
      if (typeof v === 'string' && v) categorySet.add(v);
    });
  } else if (typeof tags === 'string' && tags) {
    try {
      const parsed = JSON.parse(tags);
      if (Array.isArray(parsed)) parsed.forEach((v: any) => { if (typeof v === 'string' && v) categorySet.add(v); });
      else categorySet.add(tags);
    } catch {
      categorySet.add(tags);
    }
  }

  const cats = post.category || post.categories || [];
  if (Array.isArray(cats)) {
    cats.forEach((c: any) => {
      const v = typeof c === 'string' ? c : c?.value || c?.name;
      if (typeof v === 'string' && v) categorySet.add(v);
    });
  }
});

const categories = Array.from(categorySet)
  .sort()
  .map((label: string) => ({ label, slug: label.toLowerCase().replace(/\s+/g, '-') }));
---

<Layout title="Category - Kotacom.id">
  <main class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-8">Category</h1>
    
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {categories.map(({ label, slug }) => (
        <a 
          href={`/category/${slug}/`}
          class="block p-4 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition-shadow border border-gray-200 dark:border-gray-700"
        >
          <span class="text-gray-900 dark:text-white font-medium">{label}</span>
        </a>
      ))}
    </div>
  </main>
</Layout>
---
import { type CollectionEntry, getCollection } from 'astro:content';
import ProductPage from '../../layouts/ProductPage.astro';
import { render } from 'astro:content';
import { getProductsDirectFromSupabase } from '../../lib/supabase-direct';

export async function getStaticPaths() {
	// MD + Supabase Direct (much faster than Payload API)
	const mdxProducts = await getCollection('productsMdx');
	const supabaseProducts = await getProductsDirectFromSupabase(500, 'published'); // Only published products
	console.log(`ï¿½ Building static paths for ${supabaseProducts?.length || 0} products (direct from Supabase)`);
	
	const mdxPaths = mdxProducts.map((product: any) => ({
		params: { slug: product.data.slug },
		props: { product, source: 'mdx' as const },
	}));
	
	const supabasePaths = (supabaseProducts||[])
		.filter((product:any) => product.slug && typeof product.slug === 'string')
		.map((product:any)=> ({
			params: { slug: product.slug },
			props: { product, source: 'supabase' as const }
		}));
	
	return [...mdxPaths, ...supabasePaths];
}

type Props = { product: any | CollectionEntry<'productsMdx'>; source: 'mdx'|'supabase' };

const { product, source } = Astro.props;

let layoutData: any = {};
let Content: any;

if (source === 'mdx') {
  const { Content: C } = await render(product as any);
  Content = C;
  layoutData = {
    ...(product as any).data,
    title: (product as any).data.title,
    price: (product as any).data.price,
    content: (product as any).data.content || "",
    country: (product as any).data.country || [],
    locale: (product as any).data.locale || [],
    category: (product as any).data.category || [],
    slug: (product as any).data.slug,
    imageUrl: (product as any).data.imageUrl || "",
    published: { start: (product as any).data.published },
    description: (product as any).data.description || "",
    verify: (product as any).data.verify || "",
    imageUrl2: (product as any).data.imageUrl2 || "",
    imageUrl3: (product as any).data.imageUrl3 || "",
    review: (product as any).data.review || "",
    features: (product as any).data.features || [],
    name: (product as any).data.name || "",
    type: (product as any).data.type || [],
    url: (product as any).data.url || "",
    otherUrl: (product as any).data.otherUrl || "",
    tokopediaUrl: (product as any).data.tokopediaUrl || "",
    shopeeUrl: (product as any).data.shopeeUrl || "",
    blibliUrl: (product as any).data.blibliUrl || "",
    bukalapakUrl: (product as any).data.bukalapakUrl || "",
    lazadaUrl: (product as any).data.lazadaUrl || "",
    mapsUrl: (product as any).data.mapsUrl || "",
    affiliateCode: (product as any).data.affiliateCode || "",
    commissionRate: (product as any).data.commissionRate || "",
    affiliateProvider: (product as any).data.affiliateProvider || "",
    discountCode: (product as any).data.discountCode || "",
    specialOffer: (product as any).data.specialOffer || "",
    ctaText: (product as any).data.ctaText || "",
    priority: (product as any).data.priority || "",
    externalRating: (product as any).data.externalRating || "",
    soldCount: (product as any).data.soldCount || "",
    originalPrice: (product as any).data.originalPrice || "",
    isSponsored: !!(product as any).data.isSponsored,
    targetAudience: (product as any).data.targetAudience || [],
    // Additional fields that might be in MDX
    brand: (product as any).data.brand || "",
    model: (product as any).data.model || "",
    warranty: (product as any).data.warranty || "",
    condition: (product as any).data.condition || "",
    weight: (product as any).data.weight || "",
    dimensions: (product as any).data.dimensions || "",
    color: (product as any).data.color || "",
    material: (product as any).data.material || "",
    availability: (product as any).data.availability || "",
    stockQuantity: (product as any).data.stockQuantity || "",
    minimumOrder: (product as any).data.minimumOrder || "",
    shippingInfo: (product as any).data.shippingInfo || "",
    returnPolicy: (product as any).data.returnPolicy || "",
    tags: (product as any).data.tags || [],
    seoTitle: (product as any).data.seoTitle || "",
    seoDescription: (product as any).data.seoDescription || "",
    metaKeywords: (product as any).data.metaKeywords || "",
  };
} else if (source === 'supabase') {
  Content = undefined;
  layoutData = {
    properties: {
      // Core fields with proper fallbacks
      title: product.title || product.name || 'Untitled Product',
      price: product.price || product.original_price || '',
      content: product.body || product.content || "",
      country: Array.isArray(product.country) ? product.country.map((x:any)=>x.value||x) : (product.country ? [product.country] : []),
      locale: Array.isArray(product.locale) ? product.locale.map((x:any)=>x.value||x) : (product.locale ? [product.locale] : []),
      category: Array.isArray(product.category) ? product.category.map((x:any)=>x.value||x) : (product.category ? [product.category] : []),
      slug: product.slug,
      imageUrl: product.imageUrl || product.cover_image || product.image_url || product.image_url_1 || product.image1 || "",
      published: product.published ? (product.published instanceof Date ? product.published : new Date(product.published)) : new Date(),
      description: product.description || product.body || "",
      verify: product.verify || product.verification || "",
      imageUrl2: product.imageUrl2 || product.image_url_2 || product.image2 || "",
      imageUrl3: product.imageUrl3 || product.image_url_3 || product.image3 || "",
      review: product.review || product.reviews || "",
      features: Array.isArray(product.features) ? product.features : (product.features ? [product.features] : []),
      name: product.name || product.product_name || product.title || "",
      type: Array.isArray(product.type) ? product.type.map((x:any)=>x.value||x) : (product.type ? [product.type] : []),
      url: product.url || product.product_url || product.link || "",
      otherUrl: product.otherUrl || product.other_url || "",
      tokopediaUrl: product.tokopediaUrl || product.tokopedia_url || product.tokopedia || "",
      shopeeUrl: product.shopeeUrl || product.shopee_url || product.shopee || "",
      blibliUrl: product.blibliUrl || product.blibli_url || product.blibli || "",
      bukalapakUrl: product.bukalapakUrl || product.bukalapak_url || product.bukalapak || "",
      lazadaUrl: product.lazadaUrl || product.lazada_url || product.lazada || "",
      mapsUrl: product.mapsUrl || product.maps_url || "",
      affiliateCode: product.affiliateCode || product.affiliate_code || "",
      commissionRate: product.commissionRate || product.commission_rate || "",
      affiliateProvider: product.affiliateProvider || product.affiliate_provider || "",
      discountCode: product.discountCode || product.discount_code || "",
      specialOffer: product.specialOffer || product.special_offer || "",
      ctaText: product.ctaText || product.cta_text || product.cta || "",
      priority: product.priority || "",
      externalRating: product.externalRating || product.external_rating || product.rating || "",
      soldCount: product.soldCount || product.sold_count || product.sales || "",
      originalPrice: product.originalPrice || product.original_price || "",
      isSponsored: !!product.isSponsored || !!product.is_sponsored || !!product.sponsored,
      targetAudience: Array.isArray(product.targetAudience || product.target_audience) ? (product.targetAudience || product.target_audience) : (product.targetAudience || product.target_audience ? [product.targetAudience || product.target_audience] : []),
      // Additional fields that might be in Supabase
      brand: product.brand || "",
      model: product.model || "",
      warranty: product.warranty || "",
      condition: product.condition || "",
      weight: product.weight || "",
      dimensions: product.dimensions || "",
      color: product.color || "",
      material: product.material || "",
      availability: product.availability || "",
      stockQuantity: product.stockQuantity || product.stock_quantity || "",
      minimumOrder: product.minimumOrder || product.minimum_order || "",
      shippingInfo: product.shippingInfo || product.shipping_info || "",
      returnPolicy: product.returnPolicy || product.return_policy || "",
      tags: Array.isArray(product.tags) ? product.tags : (product.tags ? [product.tags] : []),
      seoTitle: product.seoTitle || product.seo_title || "",
      seoDescription: product.seoDescription || product.seo_description || "",
      metaKeywords: product.metaKeywords || product.meta_keywords || "",
    }
  };
}
---

<ProductPage {...layoutData}>
  {Content && <Content />}
</ProductPage>
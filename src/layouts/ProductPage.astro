---
import MainLayout from "./MainLayout.astro";
import SchemaMarkup from "../components/SchemaMarkup.astro";
import {
  getAffiliateMarketplaces,
  formatAffiliatePrice,
  calculateDiscountPercentage,
  getPriorityBadge,
  isSponsored,
  getCTAText,
  type AffiliateProduct
} from "../utils/affiliateUtils";

const props = Astro.props as any;
const raw = (props && (props as any).properties) ? (props as any).properties : props;

function toISO(d: any) {
  try {
    if (!d) return new Date().toISOString();
    const dd = d?.start ? d.start : d;
    const dt = dd instanceof Date ? dd : new Date(dd);
    return dt.toISOString();
  } catch { return new Date().toISOString(); }
}

const title = raw?.title || "Untitled";
const description = raw?.description || "";
const image = raw?.imageUrl || raw?.coverImage || raw?.image || 'https://res.cloudinary.com/dxyjku3eh/image/upload/v1754820661/Tanpa_judul_Presentasi__20250810_170926_0000_vdiibn.png';
const publishedISO = toISO(raw?.published);
const modifiedISO = toISO(raw?.updated || raw?.lastUpdated || raw?.published);

const category = Array.isArray(raw?.category)
  ? raw.category.filter(Boolean)
  : (raw?.category ? [raw.category] : []);

const contentHtml: string = typeof raw?.content === 'string' ? raw.content : '';
const reviewHtml: string = typeof raw?.review === 'string' ? raw.review : '';

// Affiliate data normalization
const affiliateProduct: AffiliateProduct = {
  title: raw?.title || title,
  slug: raw?.slug || '',
  price: raw?.price,
  originalPrice: raw?.originalPrice,
  imageUrl: raw?.imageUrl,
  affiliateCode: raw?.affiliateCode || raw?.affiliate_code,
  commissionRate: raw?.commissionRate || raw?.commission_rate,
  discountCode: raw?.discountCode || raw?.discount_code,
  specialOffer: raw?.specialOffer || raw?.special_offer,
  ctaText: raw?.ctaText || raw?.cta_text,
  priority: raw?.priority,
  externalRating: raw?.externalRating || raw?.external_rating,
  soldCount: raw?.soldCount || raw?.sold_count,
  isSponsored: !!raw?.isSponsored || !!raw?.is_sponsored,
  targetAudience: Array.isArray(raw?.targetAudience || raw?.target_audience) ? (raw?.targetAudience || raw?.target_audience) : [],
  tokopediaUrl: raw?.tokopediaUrl || raw?.tokopedia_url,
  shopeeUrl: raw?.shopeeUrl || raw?.shopee_url,
  blibliUrl: raw?.blibliUrl || raw?.blibli_url,
  bukalapakUrl: raw?.bukalapakUrl || raw?.bukalapak_url,
  lazadaUrl: raw?.lazadaUrl || raw?.lazada_url,
};

const affiliateMarketplaces = getAffiliateMarketplaces(affiliateProduct, 'single-page');
const formattedPrice = formatAffiliatePrice(affiliateProduct.price || '');
const formattedOriginalPrice = formatAffiliatePrice(affiliateProduct.originalPrice || '');
const discountPercentage = calculateDiscountPercentage(affiliateProduct.originalPrice || '', affiliateProduct.price || '');
const priorityBadge = getPriorityBadge(affiliateProduct.priority);
const sponsored = isSponsored(affiliateProduct);
---

<MainLayout title={title} description={description} image={image} type="product" published={publishedISO} modified={modifiedISO} section={category?.[0]} tags={category}>
  <SchemaMarkup
    type="product"
    title={title}
    description={description}
    image={image}
    breadcrumbs={[{ name: 'Home', url: '/' }, { name: 'Products', url: '/products' }, { name: title, url: Astro.url.toString() }]}
    datePublished={publishedISO}
    dateModified={modifiedISO}
    category={category}
  />

  <!-- Product Header with Price & Badges -->
  <section class="bg-white dark:bg-gray-900 relative">
    {sponsored && (
      <div class="absolute top-0 right-0 z-10 bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">
        SPONSORED
      </div>
    )}
    {priorityBadge && !sponsored && (
      <div class={`absolute top-0 right-0 z-10 text-xs font-bold px-3 py-1 rounded-bl-lg ${priorityBadge.class}`}>
        {priorityBadge.text}
      </div>
    )}

    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid md:grid-cols-2 gap-6 items-start">
        <div>
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-3">{title}</h1>

          {(affiliateProduct.externalRating || affiliateProduct.soldCount) && (
            <div class="flex items-center gap-3 mb-3 text-gray-600 dark:text-gray-300">
              {affiliateProduct.externalRating && (
                <div class="flex items-center">
                  <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <span class="ml-1 font-medium">{affiliateProduct.externalRating}</span>
                </div>
              )}
              {affiliateProduct.soldCount && (
                <span class="text-sm text-gray-500">({affiliateProduct.soldCount} terjual)</span>
              )}
            </div>
          )}

          {(formattedPrice || formattedOriginalPrice) && (
            <div class="mb-4">
              <div class="flex items-center gap-3">
                {formattedPrice && (
                  <span class="text-2xl sm:text-3xl font-bold text-green-600 dark:text-green-400">{formattedPrice}</span>
                )}
                {formattedOriginalPrice && discountPercentage > 0 && (
                  <span class="text-base sm:text-lg text-gray-500 line-through">{formattedOriginalPrice}</span>
                )}
                {discountPercentage > 0 && (
                  <span class="text-xs font-semibold bg-red-500 text-white px-2 py-1 rounded">-{discountPercentage}%</span>
                )}
              </div>
              {affiliateProduct.specialOffer && (
                <div class="mt-2 text-sm text-red-600 font-medium bg-red-50 dark:bg-red-900/20 px-3 py-2 rounded-lg">
                  ðŸ”¥ {affiliateProduct.specialOffer}
                </div>
              )}
              {affiliateProduct.discountCode && (
                <div class="mt-2 text-sm text-blue-600 font-medium bg-blue-50 dark:bg-blue-900/20 px-3 py-2 rounded-lg">
                  ðŸ’³ Gunakan kode: <span class="font-bold">{affiliateProduct.discountCode}</span>
                </div>
              )}
            </div>
          )}

          {affiliateProduct.description && (
            <p class="text-gray-700 dark:text-gray-300 mb-4">{description}</p>
          )}

          {category && category.length > 0 && (
            <div class="mb-4 flex flex-wrap gap-2">
              {category.map((cat: string) => (
                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">{cat}</span>
              ))}
            </div>
          )}
        </div>

        <div>
          {affiliateMarketplaces.length > 0 && (
            <div class="space-y-2">
              {affiliateMarketplaces.map((m) => (
                <a
                  href={m.affiliateUrl}
                  target="_blank"
                  rel="noopener noreferrer sponsored"
                  class={`w-full inline-flex items-center justify-between gap-2 px-4 py-3 rounded-lg font-semibold text-sm transition-all duration-200 hover:scale-[1.01] 
                    ${m.marketplace === 'tokopedia' ? 'bg-green-500 hover:bg-green-600 text-white' : ''}
                    ${m.marketplace === 'shopee' ? 'bg-orange-500 hover:bg-orange-600 text-white' : ''}
                    ${m.marketplace === 'blibli' ? 'bg-blue-500 hover:bg-blue-600 text-white' : ''}
                    ${m.marketplace === 'bukalapak' ? 'bg-red-500 hover:bg-red-600 text-white' : ''}
                    ${m.marketplace === 'lazada' ? 'bg-purple-500 hover:bg-purple-600 text-white' : ''}`}
                >
                  <span class="truncate">{getCTAText(affiliateProduct, m.marketplace)}</span>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </a>
              ))}
            </div>
          )}
        </div>
      </div>

      {raw?.features && Array.isArray(raw.features) && raw.features.length > 0 && (
        <details class="group mt-6">
          <summary class="flex items-center justify-between cursor-pointer select-none py-2 px-3 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-100">
            <span class="text-sm font-medium">Fitur</span>
            <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <ul class="mt-3 list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300 px-3">
            {raw.features.map((feature: string) => (
              <li>{feature}</li>
            ))}
          </ul>
        </details>
      )}

    </div>
  </section>

  <section class="bg-white dark:bg-gray-900">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <article class="prose prose-lg max-w-none" data-pagefind-body data-pagefind-filter="type:product">
        <slot />
      </article>
    </div>
  </section>

  {contentHtml && (
    <section class="bg-white dark:bg-gray-900">
      <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Informasi Tambahan</h2>
        <div class="prose md:prose-lg max-w-none text-gray-700 dark:text-gray-300" set:html={contentHtml} />
      </div>
    </section>
  )}

  {reviewHtml && (
    <section class="bg-blue-50 dark:bg-blue-900">
      <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">Customer Review</h2>
          <div class="prose md:prose-lg max-w-3xl mx-auto text-blue-900 dark:text-blue-100" set:html={reviewHtml} />
        </div>
      </div>
    </section>
  )}
</MainLayout>

---
import Layout from '../../../layouts/Layout.astro';
import PostCard from '../../../components/PostCard.astro';
import { getPostsDirectFromSupabase } from '../../../lib/supabase-direct';
import { getCollection } from "astro:content";

export async function getStaticPaths({ paginate }: any) {
  // Get MD/MDX posts from pages/posts directory
  const postFiles = await import.meta.glob('../../posts/*.{md,mdx}');
  const mdxPosts = await Promise.all(
    Object.entries(postFiles).map(async ([path, loader]) => {
      const post: any = await loader();
      return {
        data: post.frontmatter,
        slug: path.split('/').pop()?.replace('.mdx', '') || '',
        url: path.replace('../../posts/', '/posts/').replace('.mdx', '/')
      };
    })
  );
  
  const supabasePosts = await getPostsDirectFromSupabase(10000); // Load all posts to capture all tags/categories
  
  // Extract unique tags from all sources
  const allTags = new Set<string>();
  const slugify = (s: string) => s.toLowerCase().trim().replace(/\s+/g, '-');
  
  // Extract tags from MDX posts
  mdxPosts.forEach((post: any) => {
    (post.data.tags || []).forEach((tag: string) => {
      if (tag && typeof tag === 'string') {
        allTags.add(tag);
      }
    });
  });
  
  // Extract tags and categories from Supabase posts - improved extraction
  (supabasePosts || []).forEach((post: any) => {
    const tags = post.tags || [];
    if (Array.isArray(tags)) {
      tags.forEach((tag: any) => {
        const tagValue = typeof tag === 'string' ? tag : tag?.value || tag?.name;
        if (tagValue && typeof tagValue === 'string') {
          allTags.add(tagValue);
        }
      });
    }
    const cats = post.category || post.categories || [];
    if (Array.isArray(cats)) {
      cats.forEach((cat: any) => {
        const catValue = typeof cat === 'string' ? cat : cat?.value || cat?.name;
        if (catValue && typeof catValue === 'string') {
          allTags.add(catValue);
        }
      });
    }
  });

  const paths: any[] = [];
  
  for (const label of allTags) {
    const slug = slugify(label);
    // Filter MDX posts by category (from tags) normalized by slug
    const mdxPostsWithTag = mdxPosts.filter((post: any) => {
      const tags = post.data.tags || [];
      return Array.isArray(tags) && tags.some((t: string) => slugify(String(t)) === slug);
    });

    // Filter Supabase posts by tag/category normalized by slug
    const supabasePostsWithTag = (supabasePosts || []).filter((post: any) => {
      const tags = post.tags || [];
      const cats = post.category || post.categories || [];
      const matchTags = Array.isArray(tags) && tags.some((postTag: any) => {
        const v = typeof postTag === 'string' ? postTag : postTag?.value || postTag?.name;
        return v && slugify(String(v)) === slug;
      });
      const matchCats = Array.isArray(cats) && cats.some((c: any) => {
        const v = typeof c === 'string' ? c : c?.value || c?.name;
        return v && slugify(String(v)) === slug;
      });
      return matchTags || matchCats;
    });

    const allPostsWithTag = [
      ...mdxPostsWithTag.map((post: any) => ({ ...post, source: 'mdx' })),
      ...supabasePostsWithTag.map((post: any) => ({ ...post, source: 'supabase' })),
    ];

    if (allPostsWithTag.length > 0) {
      paths.push(
        ...paginate(allPostsWithTag, {
          params: { tag: slug },
          pageSize: 12,
        })
      );
    }
  }
  
  return paths;
}

type Props = {
  page: any;
  tag?: string;
};

const { page } = Astro.props;
const tag = page.params?.tag || Astro.params.tag;
---

<Layout title={`Kategori: ${tag} - Kotacom.id`}>
  <main class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <nav class="text-sm breadcrumbs mb-4">
        <a href="/" class="text-blue-600 hover:underline">Home</a>
        <span class="mx-2">/</span>
        <a href="/category/" class="text-blue-600 hover:underline">Category</a>
        <span class="mx-2">/</span>
        <span class="text-gray-600">{tag}</span>
      </nav>
      
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
        Kategori: {tag}
      </h1>
      <p class="text-gray-600 dark:text-gray-400">
        {page.total} artikel ditemukan
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      {page.data.map((post: any) => {
        // Normalize post data for PostCard
        if (post.source === 'mdx') {
          return (
            <PostCard 
              post={{
                source: 'mdx',
                data: {
                  properties: {
                    bSlug: post.data.slug,
                    bCoverImage: post.data.coverImage || "",
                    bTags: post.data.tags || [],
                    bTitle: post.data.title
                  }
                }
              }}
            />
          );
        } else {
          // Supabase posts
          return (
            <PostCard 
              post={{
                source: 'supabase',
                data: {
                  properties: {
                    bSlug: post.slug,
                    bCoverImage: post.imageUrl || post.coverImage || "",
                    bTags: Array.isArray(post.tags) ? post.tags.map((tag: any) => 
                      typeof tag === 'string' ? tag : tag?.value || tag?.name || tag
                    ) : [],
                    bTitle: post.title
                  }
                }
              }}
            />
          );
        }
      })}
    </div>

    <!-- Pagination -->
    {page.url.prev || page.url.next ? (
      <div class="flex justify-center items-center space-x-4 mt-8">
        {page.url.prev && (
          <a 
            href={page.url.prev}
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
          >
            ← Sebelumnya
          </a>
        )}
        
        <span class="text-gray-600 dark:text-gray-400">
          Halaman {page.currentPage} dari {page.lastPage}
        </span>
        
        {page.url.next && (
          <a 
            href={page.url.next}
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
          >
            Selanjutnya →
          </a>
        )}
      </div>
    ) : null}
  </main>
</Layout>

---
import type { MegaMenuSection } from './MegaMenu.astro';

export interface MobileMegaMenuProps {
  trigger: string;
  sections: MegaMenuSection[];
  className?: string;
}

const { trigger, sections, className = '' } = Astro.props as MobileMegaMenuProps;
const menuId = `mobile-mega-menu-${trigger.toLowerCase().replace(/\s+/g, '-')}`;
---

<div class={`w-full ${className}`}>
  <!-- Mobile Menu Trigger -->
  <button
    type="button"
    class="flex items-center justify-between w-full px-4 py-3 text-left text-gray-700 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white font-medium transition-colors duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded-md border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"
    aria-expanded="false"
    aria-haspopup="true"
    aria-controls={menuId}
    data-mobile-mega-menu-trigger={menuId}
  >
    <span class="text-base font-medium">{trigger}</span>
    <svg 
      class="w-5 h-5 transition-transform duration-200 mobile-mega-menu-chevron" 
      fill="none" 
      stroke="currentColor" 
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <!-- Mobile Menu Content -->
  <div
    id={menuId}
    class="w-full bg-white dark:bg-gray-900 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"
    role="menu"
    aria-labelledby={`${menuId}-trigger`}
    data-mobile-mega-menu-content={menuId}
  >
    <div class="px-4 py-2 space-y-3">
      {sections.map((section, sectionIndex) => (
        <div class="border-b border-gray-100 dark:border-gray-800 pb-3 last:border-b-0 last:pb-0">
          <!-- Section Header with Toggle -->
          <button
            type="button"
            class="flex items-center justify-between w-full py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-800 rounded-md px-2 transition-colors duration-200"
            data-mobile-section-toggle={`${menuId}-section-${sectionIndex}`}
            aria-expanded="false"
          >
            <div class="flex items-center gap-2">
              {section.icon && (
                <div class="text-red-600 dark:text-red-400 text-sm" set:html={section.icon}></div>
              )}
              <h3 class="text-sm font-semibold text-gray-900 dark:text-white">
                {section.title}
              </h3>
            </div>
            <svg 
              class="w-4 h-4 transition-transform duration-200 mobile-section-chevron text-gray-400" 
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          
          <!-- Section Items -->
          <div 
            class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out ml-4"
            data-mobile-section-content={`${menuId}-section-${sectionIndex}`}
          >
            <div class="space-y-1 pt-2">
              {section.items.map((item) => (
                <a
                  href={item.url}
                  class="group/item flex items-center gap-3 p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
                  role="menuitem"
                  {...(item.isExternal && {
                    target: "_blank",
                    rel: "noopener noreferrer"
                  })}
                >
                  <!-- Item Icon -->
                  {item.icon && (
                    <div class="flex-shrink-0 text-gray-400 group-hover/item:text-red-600 dark:group-hover/item:text-red-400 transition-colors text-sm" set:html={item.icon}></div>
                  )}
                  
                  <!-- Item Content -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover/item:text-red-600 dark:group-hover/item:text-red-400 transition-colors">
                        {item.title}
                      </span>
                      {item.badge && (
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">
                          {item.badge}
                        </span>
                      )}
                      {item.isExternal && (
                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                      )}
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Handle mobile mega menu interactions
    const mobileMegaMenus = document.querySelectorAll('[data-mobile-mega-menu-trigger]');
    
    mobileMegaMenus.forEach(trigger => {
      const menuId = trigger.getAttribute('data-mobile-mega-menu-trigger');
      const menuContent = document.querySelector(`[data-mobile-mega-menu-content="${menuId}"]`) as HTMLElement;
      
      if (!menuContent) return;
      
      // Main menu toggle
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        const isOpen = trigger.getAttribute('aria-expanded') === 'true';
        
        if (isOpen) {
          // Close menu
          trigger.setAttribute('aria-expanded', 'false');
          menuContent.style.maxHeight = '0px';
          trigger.querySelector('.mobile-mega-menu-chevron')?.classList.remove('rotate-180');
          
          // Close all sections
          const sectionButtons = menuContent.querySelectorAll('[data-mobile-section-toggle]');
          sectionButtons.forEach(sectionButton => {
            const sectionId = sectionButton.getAttribute('data-mobile-section-toggle');
            const sectionContent = document.querySelector(`[data-mobile-section-content="${sectionId}"]`) as HTMLElement;
            
            sectionButton.setAttribute('aria-expanded', 'false');
            if (sectionContent) sectionContent.style.maxHeight = '0px';
            sectionButton.querySelector('.mobile-section-chevron')?.classList.remove('rotate-180');
          });
        } else {
          // Close other mobile menus first
          mobileMegaMenus.forEach(otherTrigger => {
            if (otherTrigger !== trigger) {
              const otherMenuId = otherTrigger.getAttribute('data-mobile-mega-menu-trigger');
              const otherMenuContent = document.querySelector(`[data-mobile-mega-menu-content="${otherMenuId}"]`) as HTMLElement;
              
              otherTrigger.setAttribute('aria-expanded', 'false');
              if (otherMenuContent) otherMenuContent.style.maxHeight = '0px';
              otherTrigger.querySelector('.mobile-mega-menu-chevron')?.classList.remove('rotate-180');
            }
          });
          
          // Open menu
          trigger.setAttribute('aria-expanded', 'true');
          menuContent.style.maxHeight = menuContent.scrollHeight + 'px';
          trigger.querySelector('.mobile-mega-menu-chevron')?.classList.add('rotate-180');
        }
      });
      
      // Handle section toggles
      const sectionToggleButtons = menuContent.querySelectorAll('[data-mobile-section-toggle]');
      sectionToggleButtons.forEach(sectionButton => {
        sectionButton.addEventListener('click', (e) => {
          e.preventDefault();
          const sectionId = sectionButton.getAttribute('data-mobile-section-toggle');
          const sectionContent = document.querySelector(`[data-mobile-section-content="${sectionId}"]`) as HTMLElement;
          const chevron = sectionButton.querySelector('.mobile-section-chevron');
          
          if (!sectionContent) return;
          
          const isOpen = sectionButton.getAttribute('aria-expanded') === 'true';
          
          if (isOpen) {
            // Close section
            sectionButton.setAttribute('aria-expanded', 'false');
            sectionContent.style.maxHeight = '0px';
            chevron?.classList.remove('rotate-180');
          } else {
            // Open section (allow multiple sections to be open)
            sectionButton.setAttribute('aria-expanded', 'true');
            sectionContent.style.maxHeight = sectionContent.scrollHeight + 'px';
            chevron?.classList.add('rotate-180');
          }
          
          // Recalculate main menu height
          setTimeout(() => {
            if (trigger.getAttribute('aria-expanded') === 'true') {
              menuContent.style.maxHeight = menuContent.scrollHeight + 'px';
            }
          }, 100);
        });
      });
    });
    
    // Close mobile menus on outside click
    document.addEventListener('click', (e) => {
      const target = e.target as Element;
      if (!target.closest('[data-mobile-mega-menu-trigger], [data-mobile-mega-menu-content]')) {
        mobileMegaMenus.forEach(trigger => {
          const menuContent = document.querySelector(`[data-mobile-mega-menu-content="${trigger.getAttribute('data-mobile-mega-menu-trigger')}"]`) as HTMLElement;
          trigger.setAttribute('aria-expanded', 'false');
          if (menuContent) menuContent.style.maxHeight = '0px';
          trigger.querySelector('.mobile-mega-menu-chevron')?.classList.remove('rotate-180');
        });
      }
    });
  });
</script>

<style>
  /* Mobile mega menu specific styles */
  [data-mobile-mega-menu-content] {
    transition: max-height 0.3s ease-in-out;
  }
  
  [data-mobile-section-content] {
    transition: max-height 0.3s ease-in-out;
  }
  
  /* Chevron animations */
  .mobile-mega-menu-chevron, .mobile-section-chevron {
    transition: transform 0.2s ease-in-out;
  }
  
  .mobile-mega-menu-chevron.rotate-180, .mobile-section-chevron.rotate-180 {
    transform: rotate(180deg);
  }
  
  /* Focus styles for accessibility */
  [data-mobile-mega-menu-trigger]:focus-visible,
  [data-mobile-section-toggle]:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
  
  /* Smooth hover transitions */
  [data-mobile-mega-menu-trigger],
  [data-mobile-section-toggle] {
    transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
  }
  
  /* Ensure proper spacing */
  [data-mobile-section-content] {
    overflow: hidden;
  }
</style>

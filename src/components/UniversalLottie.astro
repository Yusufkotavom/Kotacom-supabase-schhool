---
export interface UniversalLottieProps {
  src?: string;
  alt?: string;
  className?: string;
  width?: string | number;
  height?: string | number;
  theme?: 'web' | 'mobile' | 'seo' | 'business' | 'migration' | 'generic';
  priority?: boolean;
}

const {
  src,
  alt = "Website Animation",
  className = "",
  width = "100%",
  height = "400px",
  theme = 'generic',
  priority = false
} = Astro.props as UniversalLottieProps;

const animationId = `universal-lottie-${Math.random().toString(36).substr(2, 9)}`;

// Default animations for different themes
const getAnimationForTheme = (theme: string) => {
  const animations = {
    web: "https://assets9.lottiefiles.com/packages/lf20_jcikwtur.json",
    mobile: "https://assets2.lottiefiles.com/packages/lf20_8pL7sj.json",
    seo: "https://assets8.lottiefiles.com/packages/lf20_t9gkkuto.json",
    business: "https://assets2.lottiefiles.com/packages/lf20_jcikwtur.json",
    migration: "https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json",
    generic: "https://assets2.lottiefiles.com/packages/lf20_jcikwtur.json"
  };
  return animations[theme as keyof typeof animations] || animations.generic;
};

const animationSrc = src || getAnimationForTheme(theme);

// Get fallback image based on theme
const getFallbackImage = (theme: string) => {
  const fallbackImages = {
    web: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
    mobile: 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
    seo: 'https://images.unsplash.com/photo-1562577309-2592ab84b1bc?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
    business: 'https://images.unsplash.com/photo-1552664730-d307ca884978?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
    migration: 'https://images.unsplash.com/photo-1555949963-aa79dcee981c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
    generic: 'https://images.unsplash.com/photo-1555949963-aa79dcee981c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80'
  };
  return fallbackImages[theme as keyof typeof fallbackImages] || fallbackImages.generic;
};

const fallbackImage = getFallbackImage(theme);
---

<div
  id={animationId}
  class={`universal-lottie-container ${className}`}
  data-src={animationSrc}
  data-fallback-image={fallbackImage}
  data-priority={priority}
  style={`width: ${width}; height: ${height};`}
  role="img"
  aria-label={alt}
>
  <!-- Beautiful fallback image with overlay -->
  <div class="universal-lottie-fallback relative w-full h-full overflow-hidden rounded-lg">
    <img
      src={fallbackImage}
      alt={alt}
      class="w-full h-full object-cover"
      loading="eager"
      decoding="async"
    />

    <!-- Elegant loading overlay -->
    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent flex items-end justify-center pb-8">
      <div class="bg-white/95 backdrop-blur-sm rounded-full px-6 py-3 flex items-center shadow-lg">
        <div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent mr-3"></div>
        <span class="text-sm font-medium text-gray-800">Memuat animasi...</span>
      </div>
    </div>

    <!-- Theme-specific floating elements -->
    {theme === 'web' && (
      <div class="absolute top-4 right-4 bg-blue-500 text-white px-2 py-1 rounded text-xs font-semibold">
        Web Dev
      </div>
    )}
    {theme === 'migration' && (
      <div class="absolute top-4 right-4 bg-purple-500 text-white px-2 py-1 rounded text-xs font-semibold">
        Migration
      </div>
    )}
    {theme === 'business' && (
      <div class="absolute top-4 right-4 bg-green-500 text-white px-2 py-1 rounded text-xs font-semibold">
        Business
      </div>
    )}
  </div>
</div>

<script define:vars={{ animationId }}>
  // Universal Lottie Loader - Optimized for performance
  class UniversalLottieLoader {
    static instance = null;
    lottie = null;
    loaded = false;

    constructor() {
      this.init();
    }

    static getInstance() {
      if (!UniversalLottieLoader.instance) {
        UniversalLottieLoader.instance = new UniversalLottieLoader();
      }
      return UniversalLottieLoader.instance;
    }

    init() {
      // Smart loading strategy
      this.smartLoadStrategy();
    }

    smartLoadStrategy() {
      const loadLottie = async () => {
        if (this.loaded) return;

        try {
          if (window.lottie) {
            this.lottie = window.lottie;
            this.loaded = true;
            this.processAllContainers();
            return;
          }

          await this.loadLottieLibrary();
          this.loaded = true;
          this.processAllContainers();
        } catch (error) {
          console.warn('Lottie failed to load, using fallback images:', error);
        }
      };

      // Load after page becomes interactive
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(loadLottie, 1500);
        });
      } else {
        setTimeout(loadLottie, 1500);
      }

      // Also load on first user interaction
      const loadOnInteraction = () => {
        loadLottie();
        document.removeEventListener('click', loadOnInteraction);
        document.removeEventListener('scroll', loadOnInteraction);
      };

      document.addEventListener('click', loadOnInteraction, { once: true });
      document.addEventListener('scroll', loadOnInteraction, { once: true });
    }

    async loadLottieLibrary() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js';
        script.crossOrigin = 'anonymous';
        script.onload = () => {
          this.lottie = window.lottie;
          resolve();
        };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    processAllContainers() {
      if (!this.lottie) return;

      document.querySelectorAll('.universal-lottie-container').forEach(container => {
        this.createAnimationForContainer(container);
      });
    }

    async createAnimationForContainer(container) {
      const src = container.getAttribute('data-src');
      if (!src) return;

      try {
        const response = await fetch(src, {
          cache: 'default',
          priority: container.getAttribute('data-priority') === 'true' ? 'high' : 'auto'
        });

        if (!response.ok) throw new Error('Animation fetch failed');

        const animationData = await response.json();

        const animation = this.lottie.loadAnimation({
          container,
          renderer: 'svg',
          loop: true,
          autoplay: true,
          animationData,
          rendererSettings: {
            preserveAspectRatio: 'xMidYMid slice'
          }
        });

        // Smooth transition to animation
        const fallback = container.querySelector('.universal-lottie-fallback');
        if (fallback) {
          fallback.style.transition = 'opacity 0.6s ease-out';
          setTimeout(() => {
            if (fallback) {
              fallback.style.opacity = '0';
              setTimeout(() => {
                if (fallback.parentNode) {
                  fallback.parentNode.removeChild(fallback);
                }
              }, 600);
            }
          }, 300);
        }

        // Add subtle hover effect
        container.addEventListener('mouseenter', () => {
          container.style.transform = 'scale(1.01)';
          container.style.transition = 'transform 0.3s ease';
        });

        container.addEventListener('mouseleave', () => {
          container.style.transform = 'scale(1)';
        });

      } catch (error) {
        console.warn('Animation failed, keeping fallback:', error);
        // Keep fallback image visible
      }
    }
  }

  // Initialize when DOM is ready
  if (typeof document !== 'undefined') {
    UniversalLottieLoader.getInstance();
  }
</script>

<style>
  .universal-lottie-container {
    position: relative;
    overflow: hidden;
    border-radius: 0.75rem;
    transition: transform 0.3s ease;
    will-change: transform;
  }

  .universal-lottie-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .universal-lottie-fallback img {
    transition: transform 0.3s ease;
  }

  .universal-lottie-fallback:hover img {
    transform: scale(1.05);
  }

  /* Loading animation */
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .universal-lottie-fallback .animate-spin {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .universal-lottie-container {
      border-radius: 0.5rem;
    }

    .universal-lottie-fallback .bg-white\/95 {
      padding: 0.75rem;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .universal-lottie-fallback .bg-white\/95 {
      background: rgba(0, 0, 0, 0.9);
      color: white;
    }

    .universal-lottie-fallback .text-gray-800 {
      color: white;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .universal-lottie-container,
    .universal-lottie-container:hover,
    .universal-lottie-fallback:hover img {
      transform: none !important;
      transition: none !important;
    }

    .universal-lottie-fallback .animate-spin {
      animation: none;
    }
  }
</style>

---
import MainLayout from "./MainLayout.astro";

const props = Astro.props as any;

function toISO(input: any) {
  try {
    if (!input) return new Date().toISOString();
    const value = input?.start ? input.start : input;
    const date = value instanceof Date ? value : new Date(value);
    return date.toISOString();
  } catch {
    return new Date().toISOString();
  }
}

function toStringArray(value: any): string[] {
  if (!value) return [];
  if (Array.isArray(value)) return value.map((x) => (typeof x === 'string' ? x : (x?.value ?? String(x)))).filter(Boolean);
  return [typeof value === 'string' ? value : (value?.value ?? String(value))].filter(Boolean);
}

const raw = props?.properties ? props.properties : props;

const normalized = {
  title: props.title ?? raw?.bTitle ?? raw?.title ?? 'Untitled',
  description: props.description ?? raw?.bDescription ?? raw?.description ?? '',
  image: props.image ?? props.imageUrl ?? props.coverImage ?? raw?.bCoverImage ?? raw?.coverImage ?? raw?.image ?? 'https://res.cloudinary.com/dxyjku3eh/image/upload/v1754820661/Tanpa_judul_Presentasi__20250810_170926_0000_vdiibn.png',
  publishedISO: toISO(props.published ?? props.publishedAt ?? raw?.bPublished ?? raw?.published),
  updatedISO: toISO(props.updated ?? props.lastUpdated ?? raw?.bLastUpdated ?? raw?.lastUpdated ?? props.published ?? props.publishedAt ?? raw?.published),
  tags: [...toStringArray(props.tags), ...toStringArray(props.category), ...toStringArray(raw?.bTags)],
  author: props.author ?? 'Kotacom.id',
  slug: props.slug ?? raw?.bSlug ?? raw?.slug ?? '',
  contentHtml: props.content ?? props.body ?? ''
};

const readingTime = normalized.contentHtml
  ? Math.ceil(normalized.contentHtml.replace(/<[^>]*>/g, ' ').split(/\s+/).filter(Boolean).length / 200)
  : undefined;
---

<MainLayout
  title={normalized.title}
  description={normalized.description || ("Artikel tentang " + normalized.title)}
  image={normalized.image}
  type="article"
  published={normalized.publishedISO}
  modified={normalized.updatedISO}
  section={normalized.tags?.[0]}
  tags={normalized.tags}
>
  <section class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <nav class="text-sm mb-3 text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:underline">Home</a>
        <span class="mx-2">/</span>
        <a href="/posts/" class="hover:underline">Posts</a>
        <span class="mx-2">/</span>
        <span class="text-gray-800 dark:text-gray-200">{normalized.title}</span>
      </nav>

      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">{normalized.title}</h1>
      {normalized.description && (
        <p class="mt-2 text-gray-600 dark:text-gray-300">{normalized.description}</p>
      )}

      <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-3">
        <time datetime={normalized.publishedISO}>Published {new Date(normalized.publishedISO).toLocaleDateString('id-ID')}</time>
        <span>•</span>
        <time datetime={normalized.updatedISO}>Updated {new Date(normalized.updatedISO).toLocaleDateString('id-ID')}</time>
        {readingTime && (
          <>
            <span>•</span>
            <span>{readingTime} menit baca</span>
          </>
        )}
      </div>

      {normalized.tags?.length > 0 && (
        <div class="mt-4 flex flex-wrap gap-2">
          {normalized.tags.slice(0, 6).map((t) => (
            <a href={`/category/${t.toLowerCase().replace(/\s+/g, '-')}/`} class="px-2 py-1 rounded-full text-xs bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">{t}</a>
          ))}
        </div>
      )}
    </div>
  </section>

  <section class="bg-white dark:bg-gray-900">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <article class="prose prose-lg max-w-none dark:prose-invert" data-pagefind-body>
        <slot />
        {normalized.contentHtml && <div set:html={normalized.contentHtml} />}
        {normalized.tags?.length > 0 && (
          <span class="hidden" data-pagefind-meta="categories">{normalized.tags.join(', ')}</span>
        )}
      </article>
    </div>
  </section>
</MainLayout>

---
// Redirect Tester Component - Development Only
// Shows redirect statistics and allows testing redirect rules

import { devUtils, redirectManager } from '../lib/redirect-utils';

// Only show in development
const isDev = import.meta.env.DEV;

let testResults: any[] = [];
let stats: any = null;
let validation: any[] = [];

if (isDev) {
  try {
    // Test common redirect paths
    testResults = devUtils.testAllRules([
      '/',
      '/blog/sample-post',
      '/posts/sample-post',
      '/layanan/website',
      '/home',
      '/about-us',
      '/contact-us',
      '/portfolio',
      '/portfolio/project-1',
      '/wa',
      '/wa/service',
      '/service',
      '/product',
      '/project'
    ]);
    
    // Get redirect statistics
    stats = redirectManager.getStats();
    
    // Validate all rules
    validation = devUtils.validateAllRules();
    
  } catch (error) {
    console.warn('‚ö†Ô∏è Redirect tester error:', error);
  }
}

const invalidRules = validation.filter(v => !v.validation.valid);
---

{isDev && (
  <div id="redirect-tester" class="fixed bottom-4 right-4 z-50 max-w-md">
    <!-- Toggle Button -->
    <button 
      id="redirect-toggle"
      class="mb-2 w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-colors duration-200"
      onclick="document.getElementById('redirect-panel').classList.toggle('hidden')"
    >
      üîÑ Redirect Tester ({stats?.enabled || 0} rules)
    </button>
    
    <!-- Main Panel -->
    <div 
      id="redirect-panel" 
      class="hidden bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl max-h-96 overflow-y-auto"
    >
      <div class="p-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-bold text-gray-900 dark:text-white">Redirect Management</h3>
          <button 
            onclick="document.getElementById('redirect-panel').classList.add('hidden')"
            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
        
        <!-- Statistics -->
        {stats && (
          <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <h4 class="text-xs font-semibold text-gray-900 dark:text-white mb-2">Statistics</h4>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>
                <span class="text-gray-600 dark:text-gray-400">Total:</span>
                <span class="font-medium text-gray-900 dark:text-white ml-1">{stats.total}</span>
              </div>
              <div>
                <span class="text-gray-600 dark:text-gray-400">Enabled:</span>
                <span class="font-medium text-green-600 dark:text-green-400 ml-1">{stats.enabled}</span>
              </div>
              <div>
                <span class="text-gray-600 dark:text-gray-400">Disabled:</span>
                <span class="font-medium text-red-600 dark:text-red-400 ml-1">{stats.disabled}</span>
              </div>
              <div>
                <span class="text-gray-600 dark:text-gray-400">Categories:</span>
                <span class="font-medium text-blue-600 dark:text-blue-400 ml-1">{stats.byCategory.length}</span>
              </div>
            </div>
          </div>
        )}
        
        <!-- Validation Errors -->
        {invalidRules.length > 0 && (
          <div class="mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
            <h4 class="text-xs font-semibold text-red-800 dark:text-red-400 mb-2">
              ‚ùå Validation Errors ({invalidRules.length})
            </h4>
            <div class="space-y-1">
              {invalidRules.map(({ rule, validation }) => (
                <div class="text-xs">
                  <span class="font-medium text-red-700 dark:text-red-300">{rule.id}:</span>
                  <span class="text-red-600 dark:text-red-400 ml-1">{validation.errors.join(', ')}</span>
                </div>
              ))}
            </div>
          </div>
        )}
        
        <!-- Test Results -->
        <div class="mb-4">
          <h4 class="text-xs font-semibold text-gray-900 dark:text-white mb-2">Test Results</h4>
          <div class="space-y-1 max-h-32 overflow-y-auto">
            {testResults.map(({ path, result }) => (
              <div class="flex items-center justify-between text-xs py-1">
                <span class="font-mono text-gray-600 dark:text-gray-400 truncate flex-1 mr-2">
                  {path}
                </span>
                {result.shouldRedirect ? (
                  <div class="flex items-center gap-1 text-green-600 dark:text-green-400">
                    <span class="font-medium">{result.status}</span>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                    <span class="truncate max-w-20" title={result.destination}>
                      {result.destination}
                    </span>
                  </div>
                ) : (
                  <span class="text-gray-400 dark:text-gray-500">No redirect</span>
                )}
              </div>
            ))}
          </div>
        </div>
        
        <!-- Categories -->
        <div class="mb-4">
          <h4 class="text-xs font-semibold text-gray-900 dark:text-white mb-2">Categories</h4>
          <div class="space-y-1">
            {stats?.byCategory.map((cat: any) => (
              <div class="flex items-center justify-between text-xs">
                <span class="text-gray-600 dark:text-gray-400 truncate">{cat.category}</span>
                <span class="font-medium text-gray-900 dark:text-white">
                  {cat.enabled}/{cat.count}
                </span>
              </div>
            ))}
          </div>
        </div>
        
        <!-- Actions -->
        <div class="flex gap-2">
          <button 
            onclick="navigator.clipboard.writeText(JSON.stringify(window.redirectTestResults, null, 2))"
            class="flex-1 px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 rounded hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-colors duration-200"
          >
            Copy Results
          </button>
          <button 
            onclick="console.log('Redirect Stats:', window.redirectStats)"
            class="flex-1 px-3 py-2 text-xs font-medium text-blue-700 bg-blue-100 rounded hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-300 dark:hover:bg-blue-800 transition-colors duration-200"
          >
            Log Stats
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Make data available to console -->
  <script is:inline define:vars={{ testResults, stats }}>
    window.redirectTestResults = testResults;
    window.redirectStats = stats;
  </script>
)}

<!-- Global styles for redirect tester -->
<style>
  #redirect-tester {
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Monaco, Inconsolata, "Roboto Mono", monospace;
  }
  
  #redirect-panel {
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  @media (max-width: 640px) {
    #redirect-tester {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      max-width: none;
    }
  }
</style>
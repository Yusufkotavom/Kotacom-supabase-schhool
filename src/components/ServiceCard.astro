---
import ResponsiveImage from './ResponsiveImage.astro';
import LottieAnimation from './LottieAnimation.astro';
import { formatPrice } from '../utils/marketplaceUtils';

interface Props {
  service: {
    data: {
      properties: {
        svSlug: string;
        svImageURL1: string;
        svTitle: string;
        svProvider?: string;
        svWilayah?: string | string[];
        svCategory?: string | string[];
        svPrice?: string | number;
        svWhatsAppURL?: string;
        svType?: string;
      };
    };
  };
}

const { service } = Astro.props;
const p = service.data.properties as any;
const formattedPrice = formatPrice(p.svPrice);

// Default WA target if not provided in Notion
const DEFAULT_WA_NUMBER = '081232109396';
const waHref = p.svWhatsAppURL || `https://wa.me/62${DEFAULT_WA_NUMBER.replace(/^0/, '')}`;

// Default image if not provided
const DEFAULT_IMAGE = 'https://res.cloudinary.com/dxyjku3eh/image/upload/v1754820661/Tanpa_judul_Presentasi__20250810_170926_0000_vdiibn.png';
const imageUrl = p.svImageURL1 || DEFAULT_IMAGE;

// Lottie animation URLs for different service categories
const getLottieAnimation = (category?: string | string[]) => {
  if (!category) return '/animations/web-development.json';

  const cat = Array.isArray(category) ? category[0] : category;
  if (!cat) return '/animations/general-service.json';

  const catLower = cat.toLowerCase();
  
  if (catLower.includes('website') || catLower.includes('web')) {
    return '/animations/web-development.json';
  } else if (catLower.includes('mobile') || catLower.includes('app')) {
    return '/animations/mobile-development.json';
  } else if (catLower.includes('software') || catLower.includes('system')) {
    return '/animations/software-development.json';
  } else if (catLower.includes('design') || catLower.includes('graphic')) {
    return '/animations/design.json';
  } else if (catLower.includes('support') || catLower.includes('it')) {
    return '/animations/it-support.json';
  } else if (catLower.includes('print') || catLower.includes('printing')) {
    return '/animations/printing.json';
  } else {
    return '/animations/general-service.json';
  }
};

const lottieUrl = getLottieAnimation(p.svCategory);
---

<article class="group relative bg-white dark:bg-gray-900 rounded-2xl shadow-lg hover:shadow-2xl dark:shadow-gray-900/50 transition-all duration-500 transform hover:-translate-y-3 border border-gray-200 dark:border-gray-700 overflow-hidden">
  <!-- Enhanced hover effects overlay -->
  <div class="absolute inset-0 bg-gradient-to-br from-blue-500/0 via-purple-500/0 to-pink-500/0 group-hover:from-blue-500/10 group-hover:via-purple-500/10 group-hover:to-pink-500/10 transition-all duration-500 rounded-2xl"></div>
  
  <div class="relative">
    <a href={`/services/${p.svSlug}/`} class="block overflow-hidden">
      <!-- Lottie Animation Container -->
      <div class="relative h-48 md:h-52 lg:h-56 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 overflow-hidden">
        <LottieAnimation
          src={lottieUrl}
          alt={`${p.svTitle} animation`}
          className="w-full h-full"
          autoplay={true}
          loop={true}
          speed={0.8}
          hover={true}
          click={true}
        />
        
        <!-- Fallback Image (shown if Lottie fails to load) -->
        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
          <ResponsiveImage
            class="w-full h-full object-cover"
            src={imageUrl}
            alt={p.svTitle}
            preset="card"
            fallbackWidth={600}
          />
        </div>
        
        <!-- Hover overlay with service type -->
        <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-all duration-500 flex items-center justify-center">
          <div class="bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm px-4 py-2 rounded-full">
            <span class="text-sm font-semibold text-gray-900 dark:text-white">
              {p.svCategory ? (Array.isArray(p.svCategory) ? p.svCategory[0] : p.svCategory) : 'Service'}
            </span>
          </div>
        </div>
      </div>
    </a>
    
    <!-- Floating price badge -->
    {formattedPrice && (
      <div class="absolute top-4 right-4 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm px-3 py-1.5 rounded-full shadow-lg transform translate-y-0 group-hover:translate-y-1 transition-transform duration-300">
        <span class="text-sm font-bold text-green-600 dark:text-green-400">{formattedPrice}</span>
      </div>
    )}
  </div>

  <!-- Content -->
  <div class="p-6 relative">
    <!-- Category badge -->
    {p.svCategory && (
      <div class="mb-3">
        <span class="inline-block px-3 py-1 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 border border-blue-200 dark:border-blue-800">
          {Array.isArray(p.svCategory) ? p.svCategory[0] : p.svCategory}
        </span>
      </div>
    )}
    
    <!-- Title -->
    <h2 class="mb-3 text-xl font-bold tracking-tight text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-300">
      <a href={`/services/${p.svSlug}/`} class="hover:underline decoration-2 underline-offset-4">
        {p.svTitle}
      </a>
    </h2>

    <!-- Description -->
    <p class="mb-4 text-sm text-gray-600 dark:text-gray-300 leading-relaxed">
      {p.svProvider && (<span class="font-medium text-gray-800 dark:text-gray-200">{p.svProvider}</span>)}
      {p.svType && (<span> adalah <span class="font-medium text-gray-900 dark:text-white">{p.svType}</span></span>)}
      {p.svWilayah && (
        <span> di <span class="font-medium text-gray-900 dark:text-white">
          {Array.isArray(p.svWilayah) ? p.svWilayah.join(', ') : p.svWilayah}
        </span></span>
      )}
    </p>

    <!-- Enhanced WhatsApp CTA -->
    <a
      href={waHref}
      target="_blank"
      rel="noopener noreferrer"
      class="group/cta w-full inline-flex items-center justify-center gap-3 rounded-xl px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 transition-all duration-300 transform hover:scale-105 hover:shadow-lg border border-emerald-600/20"
    >
      <svg class="w-4 h-4 transition-transform duration-300 group-hover/cta:scale-110" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.965-.273-.099-.471-.149-.67.15-.198.297-.767.964-.94 1.162-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.521.149-.173.198-.297.298-.496.099-.198.05-.372-.025-.521-.074-.149-.669-1.611-.916-2.206-.242-.582-.487-.502-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.461 1.065 2.874 1.213 3.072.149.198 2.095 3.2 5.076 4.487.71.306 1.263.489 1.694.626.712.227 1.36.195 1.872.118.571-.085 1.758-.718 2.006-1.41.248-.694.248-1.289.173-1.41-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.999-3.648-.235-.374a9.86 9.86 0 01-1.51-5.234c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.12 1.03 6.988 2.899a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.886 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.33-1.654a11.88 11.88 0 005.713 1.456h.005c6.554 0 11.89-5.335 11.893-11.893a11.82 11.82 0 00-3.47-8.421"/>
      </svg>
      <span>Konsultasi Gratis</span>
      <svg class="w-4 h-4 transition-transform duration-300 group-hover/cta:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    </a>
  </div>

  <!-- Decorative corner accent -->
  <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-bl-2xl opacity-0 group-hover:opacity-100 transition-all duration-500"></div>
</article>
---
import { getCollection } from 'astro:content';

interface Props {
  type: 'post' | 'project' | 'product';
  limit?: number;
}

const { type, limit = 5 } = Astro.props as Props;

function toSlug(value: any): string {
  if (!value) return '';
  if (typeof value === 'string') return value;
  return String(value);
}

const currentPath = Astro.url.pathname;

let items: { title: string; href: string; date?: Date }[] = [];

if (type === 'post') {
  // MDX posts
  const mdx = await getCollection('postsMdx').catch(() => []);
  const mdxItems = mdx.map((p: any) => ({
    title: p.data?.title,
    slug: p.data?.slug,
    date: p.data?.published ? new Date(p.data.published) : undefined,
  })).filter((x: any) => x.slug).map((x: any) => ({ title: x.title, href: `/blog/${x.slug}/`, date: x.date }));

  items = [...mdxItems];
}

if (type === 'project') {
  const mdx = await getCollection('projectsMdx').catch(() => []);
  const mdxItems = mdx.map((p: any) => ({
    title: p.data?.title,
    slug: p.data?.slug,
    date: p.data?.published ? new Date(p.data.published) : undefined,
  })).filter((x: any) => x.slug).map((x: any) => ({ title: x.title, href: `/projects/${x.slug}/`, date: x.date }));

  items = [...mdxItems];
}

if (type === 'product') {
  const mdx = await getCollection('productsMdx').catch(() => []);
  const mdxItems = mdx.map((p: any) => ({
    title: p.data?.title,
    slug: p.data?.slug,
    date: p.data?.published ? new Date(p.data.published) : undefined,
  })).filter((x: any) => x.slug).map((x: any) => ({ title: x.title, href: `/products/${x.slug}/`, date: x.date }));

  items = [...mdxItems];
}

// Exclude current page
items = items.filter((it) => it.href !== currentPath);

// Sort by date desc then title
items.sort((a, b) => {
  const da = a.date ? a.date.getTime() : 0;
  const db = b.date ? b.date.getTime() : 0;
  if (db !== da) return db - da;
  return a.title.localeCompare(b.title);
});

items = items.slice(0, limit);
---

{items.length > 0 && (
  <section class="bg-white dark:bg-gray-900">
    <div class="max-w-screen-lg mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-semibold text-gray-900 dark:text-white">
          {type === 'post' ? 'Artikel Terkait' : type === 'project' ? 'Project Terkait' : 'Produk Terkait'}
        </h2>
      </div>
      <ul class="divide-y divide-gray-200 dark:divide-gray-700 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
        {items.map((it) => (
          <li class="p-3">
            <a href={it.href} class="text-sm text-blue-600 dark:text-blue-400 hover:underline">{it.title}</a>
          </li>
        ))}
      </ul>
    </div>
  </section>
)}
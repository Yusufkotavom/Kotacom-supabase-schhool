---
interface Props {
  content?: string; // raw HTML content optional, otherwise use slot
}

const { content } = Astro.props;
let html = content || '';

function extractTOC(html: string): { toc: { id: string; text: string }[]; body: string } {
  // Extract only H2 headings for a cleaner, minimal TOC
  const headingRegex = /<h(2)([^>]*)>([\s\S]*?)<\/h\1>/gi;
  const ids: Set<string> = new Set();
  const toc: { id: string; text: string }[] = [];
  function slugify(text: string): string {
    return text.toLowerCase().replace(/<[^>]+>/g, '').trim().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').slice(0, 64);
  }
  const newHtml = html.replace(headingRegex, (_m, level, attrs, inner) => {
    const text = String(inner).replace(/<[^>]+>/g, '').trim();
    let idMatch = String(attrs).match(/id\s*=\s*"([^"]+)"/i);
    let id = idMatch ? idMatch[1] : slugify(text) || `h${level}-${toc.length}`;
    let base = id;
    let n = 1;
    while (ids.has(id)) { id = `${base}-${n++}`; }
    ids.add(id);
    toc.push({ id, text });
    return `<h${level} id="${id}"${String(attrs).replace(/\s*id\s*=\s*"([^"]+)"/i,'')}>${inner}</h${level}>`;
  });
  return { toc, body: newHtml };
}

const { toc, body } = extractTOC(html);

function injectTocAfterFirstParagraph(html: string, tocItems: { id: string; text: string }[]): string {
  if (!tocItems.length) return html;
  const tocHtml = `<nav class="minimal-toc">
    <div class="toc-title">Daftar Isi</div>
    <ul>${tocItems.map(i => `<li><a href="#${i.id}">${i.text}</a></li>`).join('')}</ul>
  </nav>`;
  const pIndex = html.indexOf('</p>');
  if (pIndex !== -1) {
    return html.slice(0, pIndex + 4) + tocHtml + html.slice(pIndex + 4);
  }
  return tocHtml + html;
}

const finalHtml = injectTocAfterFirstParagraph(body || html, toc);
---

<div class="prose prose-lg max-w-none" set:html={finalHtml} />

<style>
  .minimal-toc { 
    margin: 1.5rem 0; 
    padding: 1rem 1.25rem; 
    background: linear-gradient(135deg, #e0f2fe 0%, #f1f5f9 50%, #fdf2f8 100%); 
    border: 1px solid #cbd5e1; 
    border-radius: 0.75rem; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .minimal-toc::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
  }
  
  .dark .minimal-toc { 
    background: linear-gradient(135deg, #0c4a6e 0%, #1e293b 50%, #581c87 100%); 
    border-color: #475569; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
  }
  
  .dark .minimal-toc::before {
    background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
  }
  
  .minimal-toc .toc-title { 
    font-weight: 600; 
    font-size: 0.875rem; 
    color: #1e40af; 
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .dark .minimal-toc .toc-title { 
    color: #93c5fd;
    background: linear-gradient(90deg, #60a5fa, #a78bfa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .minimal-toc ul { 
    list-style: none; 
    padding: 0; 
    margin: 0; 
    display: flex;
    flex-direction: column;
    gap: 0.375rem; 
  }
  
  .minimal-toc li {
    position: relative;
    padding-left: 0.75rem;
  }
  
  .minimal-toc li::before {
    content: 'â€¢';
    position: absolute;
    left: 0;
    color: #3b82f6;
    font-weight: bold;
  }
  
  .dark .minimal-toc li::before {
    color: #60a5fa;
  }
  
  .minimal-toc a { 
    color: #374151; 
    text-decoration: none; 
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.4;
    transition: color 0.15s ease;
  }
  
  .minimal-toc a:hover { 
    color: #3b82f6;
    text-decoration: none;
  }
  
  .dark .minimal-toc a { 
    color: #d1d5db; 
  }
  
  .dark .minimal-toc a:hover { 
    color: #60a5fa;
  }
</style>
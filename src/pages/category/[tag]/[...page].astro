---
import Layout from '../../../layouts/Layout.astro';
import PostCard from '../../../components/PostCard.astro';
import { getPostsDirectFromSupabase } from '../../../lib/supabase-direct';

export async function getStaticPaths({ paginate }: any) {
  const postFiles = await import.meta.glob('../../posts/*.{md,mdx}');
  const mdxPosts = await Promise.all(
    Object.entries(postFiles).map(async ([path, loader]) => {
      const post: any = await loader();
      return {
        data: post.frontmatter,
        slug: path.split('/').pop()?.replace(/\.(md|mdx)$/, '') || '',
        url: path.replace('../../posts/', '/posts/').replace(/\.(md|mdx)$/, '/')
      };
    })
  );

  const supabasePosts = await getPostsDirectFromSupabase(10000);
  const allTags = new Set<string>();

  mdxPosts.forEach((post: any) => {
    (post.data.tags || []).forEach((tag: string) => { if (tag) allTags.add(tag); });
  });

  (supabasePosts || []).forEach((post: any) => {
    const tags = post.tags || [];
    Array.isArray(tags) && tags.forEach((t: any) => { const v = typeof t === 'string' ? t : t?.value || t?.name; if (v) allTags.add(v); });
    const cats = post.category || post.categories || [];
    Array.isArray(cats) && cats.forEach((c: any) => { const v = typeof c === 'string' ? c : c?.value || c?.name; if (v) allTags.add(v); });
  });

  const paths: any[] = [];
  for (const tag of allTags) {
    const mdxWith = mdxPosts.filter((p: any) => (p.data.tags || []).includes(tag));
    const supaWith = (supabasePosts || []).filter((post: any) => {
      const tags = post.tags || [];
      const cats = post.category || post.categories || [];
      const matchTag = Array.isArray(tags) && tags.some((t: any) => (typeof t === 'string' ? t : t?.value || t?.name) === tag);
      const matchCat = Array.isArray(cats) && cats.some((c: any) => (typeof c === 'string' ? c : c?.value || c?.name) === tag);
      return matchTag || matchCat;
    });
    const combined = [...mdxWith.map((p:any)=>({...p, source:'mdx'})), ...supaWith.map((p:any)=>({...p, source:'supabase'}))];
    if (combined.length > 0) {
      paths.push(...paginate(combined, { params: { tag }, pageSize: 12 }));
    }
  }
  return paths;
}

const { page } = Astro.props as any;
const tag = page.params?.tag || Astro.params.tag;
---

<Layout title={`Category: ${tag} - Kotacom.id`}>
  <main class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <nav class="text-sm breadcrumbs mb-4">
        <a href="/" class="text-blue-600 hover:underline">Home</a>
        <span class="mx-2">/</span>
        <a href="/category/" class="text-blue-600 hover:underline">Category</a>
        <span class="mx-2">/</span>
        <span class="text-gray-600">{tag}</span>
      </nav>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Category: {tag}</h1>
      <p class="text-gray-600 dark:text-gray-400">{page.total} artikel ditemukan</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      {page.data.map((post: any) => (
        post.source === 'mdx' ? (
          <PostCard post={{ source:'mdx', data:{ properties: { bSlug: post.data.slug, bCoverImage: post.data.coverImage || '', bTags: post.data.tags || [], bTitle: post.data.title } } }} />
        ) : (
          <PostCard post={{ source:'supabase', data:{ properties: { bSlug: post.slug, bCoverImage: post.imageUrl || post.coverImage || '', bTags: Array.isArray(post.tags) ? post.tags.map((t:any)=> typeof t==='string'? t : t?.value || t?.name || t) : [], bTitle: post.title } } }} />
        )
      ))}
    </div>
  </main>
</Layout>


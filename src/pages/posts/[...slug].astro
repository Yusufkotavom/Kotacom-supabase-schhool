import PostLayout from '../../layouts/PostLayout.astro';
import { getPostsDirectFromSupabase, convertSupabasePost } from '../../lib/supabase-direct';
import { marked } from 'marked';

export async function getStaticPaths() {
	// Get ALL posts directly from Supabase - MUCH faster!
	const supabasePosts = await getPostsDirectFromSupabase(10000);
	console.log(`� Building static paths for ${supabasePosts?.length || 0} posts (direct from Supabase)`);
	
	const validPosts = supabasePosts
		.filter((post:any) => post.slug && typeof post.slug === 'string')
		.map(convertSupabasePost);
	
	console.log(`✅ Valid posts with slugs: ${validPosts.length}`);
	return validPosts.map((post:any)=> ({
		params: { slug: post.slug },
		props: { post }
	}));
}

type Props = { post: any };

const { post } = Astro.props;

const rawBody = post.body || post.content || "";
const contentHtml = rawBody ? await marked(rawBody) : "";

const layoutData = {
	title: post.title,
	content: contentHtml,
	tags: (post.tags||[]).map((x:any)=>x.value||x),
	category: (post.category||[]).map((x:any)=>x.value||x),
	slug: post.slug,
	imageUrl: post.imageUrl || post.coverImage || post.image || "",
	coverImage: post.coverImage || post.imageUrl || post.image || "",
	published: post.published ? new Date(post.published) : (post.publishedAt ? new Date(post.publishedAt) : new Date()),
	description: post.description || "",
	author: post.author || "Kotacom.id",
	source: 'supabase'
};
---

<PostLayout {...layoutData}>
</PostLayout>
---
import { type CollectionEntry, getCollection } from 'astro:content';
import ProductPage from '../../layouts/ProductPage.astro';
import { render } from 'astro:content';
import { getProductsDirectFromSupabase } from '../../lib/supabase-direct';

export async function getStaticPaths() {
	// MD + Supabase Direct (much faster than Payload API)
	const mdxProducts = await getCollection('productsMdx');
	const supabaseProducts = await getProductsDirectFromSupabase(10000, 'published'); // Only published products
	console.log(`ï¿½ Building static paths for ${supabaseProducts?.length || 0} products (direct from Supabase)`);
	
	const mdxPaths = mdxProducts.map((product: any) => ({
		params: { slug: product.data.slug },
		props: { product, source: 'mdx' as const },
	}));
	
	const supabasePaths = (supabaseProducts||[])
		.filter((product:any) => product.slug && typeof product.slug === 'string')
		.map((product:any)=> ({
			params: { slug: product.slug },
			props: { product, source: 'supabase' as const }
		}));
	
	return [...mdxPaths, ...supabasePaths];
}

type Props = { product: any | CollectionEntry<'productsMdx'>; source: 'mdx'|'supabase' };

const { product, source } = Astro.props;

let layoutData: any = {};
let Content: any;

if (source === 'mdx') {
  const { Content: C } = await render(product as any);
  Content = C;
  layoutData = {
    ...(product as any).data,
    title: (product as any).data.title,
    price: (product as any).data.price,
    content: (product as any).data.content || "",
    country: (product as any).data.country || [],
    locale: (product as any).data.locale || [],
    category: (product as any).data.category || [],
    slug: (product as any).data.slug,
    imageUrl: (product as any).data.imageUrl || "",
    published: { start: (product as any).data.published },
    description: (product as any).data.description || "",
    verify: (product as any).data.verify || "",
    imageUrl2: (product as any).data.imageUrl2 || "",
    imageUrl3: (product as any).data.imageUrl3 || "",
    review: (product as any).data.review || "",
    features: (product as any).data.features || [],
    name: (product as any).data.name || "",
    type: (product as any).data.type || [],
    url: (product as any).data.url || "",
    otherUrl: (product as any).data.otherUrl || "",
    tokopediaUrl: (product as any).data.tokopediaUrl || "",
    shopeeUrl: (product as any).data.shopeeUrl || "",
    blibliUrl: (product as any).data.blibliUrl || "",
    bukalapakUrl: (product as any).data.bukalapakUrl || "",
    lazadaUrl: (product as any).data.lazadaUrl || "",
    mapsUrl: (product as any).data.mapsUrl || "",
    affiliateCode: (product as any).data.affiliateCode || "",
    commissionRate: (product as any).data.commissionRate || "",
    affiliateProvider: (product as any).data.affiliateProvider || "",
    discountCode: (product as any).data.discountCode || "",
    specialOffer: (product as any).data.specialOffer || "",
    ctaText: (product as any).data.ctaText || "",
    priority: (product as any).data.priority || "",
    externalRating: (product as any).data.externalRating || "",
    soldCount: (product as any).data.soldCount || "",
    originalPrice: (product as any).data.originalPrice || "",
    isSponsored: !!(product as any).data.isSponsored,
    targetAudience: (product as any).data.targetAudience || [],
    // Additional fields that might be in MDX
    brand: (product as any).data.brand || "",
    model: (product as any).data.model || "",
    warranty: (product as any).data.warranty || "",
    condition: (product as any).data.condition || "",
    weight: (product as any).data.weight || "",
    dimensions: (product as any).data.dimensions || "",
    color: (product as any).data.color || "",
    material: (product as any).data.material || "",
    availability: (product as any).data.availability || "",
    stockQuantity: (product as any).data.stockQuantity || "",
    minimumOrder: (product as any).data.minimumOrder || "",
    shippingInfo: (product as any).data.shippingInfo || "",
    returnPolicy: (product as any).data.returnPolicy || "",
    tags: (product as any).data.tags || [],
    seoTitle: (product as any).data.seoTitle || "",
    seoDescription: (product as any).data.seoDescription || "",
    metaKeywords: (product as any).data.metaKeywords || "",
  };
} else if (source === 'supabase') {
  Content = undefined;
  layoutData = {
    properties: {
      title: product.title,
      price: product.price,
      content: product.body || product.content || "",
      country: (product.country||[]).map((x:any)=>x.value||x),
      locale: (product.locale||[]).map((x:any)=>x.value||x),
      category: (product.category||[]).map((x:any)=>x.value||x),
      slug: product.slug,
      imageUrl: product.imageUrl || product.cover_image || product.image_url || "",
      published: product.published ? new Date(product.published) : new Date(),
      description: product.description || "",
      verify: product.verify || "",
      imageUrl2: product.imageUrl2 || product.image_url_2 || "",
      imageUrl3: product.imageUrl3 || product.image_url_3 || "",
      review: product.review || "",
      features: product.features || [],
      name: product.name || product.product_name || "",
      type: (product.type||[]).map((x:any)=>x.value||x),
      url: product.url || product.product_url || "",
      otherUrl: product.otherUrl || product.other_url || "",
      tokopediaUrl: product.tokopediaUrl || product.tokopedia_url || "",
      shopeeUrl: product.shopeeUrl || product.shopee_url || "",
      blibliUrl: product.blibliUrl || product.blibli_url || "",
      bukalapakUrl: product.bukalapakUrl || product.bukalapak_url || "",
      lazadaUrl: product.lazadaUrl || product.lazada_url || "",
      mapsUrl: product.mapsUrl || product.maps_url || "",
      affiliateCode: product.affiliateCode || product.affiliate_code || "",
      commissionRate: product.commissionRate || product.commission_rate || "",
      affiliateProvider: product.affiliateProvider || product.affiliate_provider || "",
      discountCode: product.discountCode || product.discount_code || "",
      specialOffer: product.specialOffer || product.special_offer || "",
      ctaText: product.ctaText || product.cta_text || "",
      priority: product.priority || "",
      externalRating: product.externalRating || product.external_rating || "",
      soldCount: product.soldCount || product.sold_count || "",
      originalPrice: product.originalPrice || product.original_price || "",
      isSponsored: !!product.isSponsored || !!product.is_sponsored,
      targetAudience: product.targetAudience || product.target_audience || [],
      // Additional fields that might be in Supabase
      brand: product.brand || "",
      model: product.model || "",
      warranty: product.warranty || "",
      condition: product.condition || "",
      weight: product.weight || "",
      dimensions: product.dimensions || "",
      color: product.color || "",
      material: product.material || "",
      availability: product.availability || "",
      stockQuantity: product.stockQuantity || product.stock_quantity || "",
      minimumOrder: product.minimumOrder || product.minimum_order || "",
      shippingInfo: product.shippingInfo || product.shipping_info || "",
      returnPolicy: product.returnPolicy || product.return_policy || "",
      tags: product.tags || [],
      seoTitle: product.seoTitle || product.seo_title || "",
      seoDescription: product.seoDescription || product.seo_description || "",
      metaKeywords: product.metaKeywords || product.meta_keywords || "",
    }
  };
}
---

<ProductPage {...layoutData}>
  {Content && <Content />}
</ProductPage>
---
import Layout from '../../layouts/Layout.astro';
import { getPostsDirectFromSupabase } from '../../lib/supabase-direct';
import { getCollection } from "astro:content";

// Get all posts from different sources
import { glob } from 'astro/loaders';

// Get MDX posts from pages/posts directory
const postFiles = await Astro.glob('../posts/*.mdx');
const mdxPosts = postFiles.map(post => ({
  data: post.frontmatter,
  slug: post.file?.split('/').pop()?.replace('.mdx', '') || '',
  url: post.url
}));

const supabasePosts = await getPostsDirectFromSupabase(10000); // Load all posts to ensure all tags are captured
console.log(`ğŸ“‹ MDX posts found: ${mdxPosts.length}`);
console.log(`ğŸ“‹ Supabase posts found: ${supabasePosts?.length || 0}`);

// Extract unique tags from all posts (MDX + Supabase)
const allTags = new Set<string>();

// Extract tags from MDX posts
mdxPosts.forEach((post: any) => {
  (post.data.tags || []).forEach((tag: string) => {
    if (tag && typeof tag === 'string') {
      allTags.add(tag);
    }
  });
});

// Extract tags from Supabase posts
(supabasePosts || []).forEach((post: any) => {
  console.log(`ğŸ“ Supabase post "${post.title}": tags =`, post.tags);
  const tags = post.tags || [];
  if (Array.isArray(tags)) {
    tags.forEach((tag: any) => {
      const tagValue = typeof tag === 'string' ? tag : tag?.value || tag?.name;
      if (tagValue && typeof tagValue === 'string') {
        console.log(`  âœ… Adding tag: "${tagValue}"`);
        allTags.add(tagValue);
      }
    });
  } else if (typeof tags === 'string') {
    // Try to parse as JSON if it's a string
    try {
      const parsedTags = JSON.parse(tags);
      if (Array.isArray(parsedTags)) {
        parsedTags.forEach((tag: string) => {
          if (tag && typeof tag === 'string') {
            console.log(`  âœ… Adding parsed tag: "${tag}"`);
            allTags.add(tag);
          }
        });
      }
    } catch {
      // If not JSON, treat as single tag
      console.log(`  âœ… Adding single tag: "${tags}"`);
      allTags.add(tags);
    }
  }
  // Also include categories from Supabase
  const categories = post.category || post.categories || [];
  if (Array.isArray(categories)) {
    categories.forEach((cat: any) => {
      const value = typeof cat === 'string' ? cat : cat?.value || cat?.name;
      if (value && typeof value === 'string') {
        console.log(`  âœ… Adding category: "${value}"`);
        allTags.add(value);
      }
    });
  }
});

const uniqueTags = Array.from(allTags).sort();
console.log(`ğŸ·ï¸ Final unique tags (${uniqueTags.length}):`, uniqueTags);
---

<Layout title="Kategori - Kotacom.id">
  <main class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-8">Kategori</h1>
    
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {uniqueTags.map((tag) => (
        <a 
          href={`/category/${tag}/`}
          class="block p-4 bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-md transition-shadow border border-gray-200 dark:border-gray-700"
        >
          <span class="text-gray-900 dark:text-white font-medium">{tag}</span>
        </a>
      ))}
    </div>
  </main>
</Layout>